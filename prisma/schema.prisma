generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                               String               @id @default(uuid())
  name                             String
  email                            String               @unique
  password                         String?
  role                             UserRole             @default(USER)
  createdAt                        DateTime             @default(now())
  updatedAt                        DateTime             @updatedAt
  googleId                         String?
  tokenVersion                     Int                  @default(0)
  deletedAt                        DateTime?
  colaboradoresExternosRegistrados ColaboradorExterno[] @relation("ColaboradorExternoRegistradoPor")
  createdKanbanBoards              KanbanBoard[]        @relation("KanbanBoardCreatedBy")
  kanbanCardAssignments            KanbanCard[]
  kanbanMemberships                KanbanMember[]
  notifications                    Notification[]
  createdProjects                  Project[]            @relation("ProjectCreatedBy")
  createdTasks                     Task[]               @relation("TaskCreatedBy")
  taskActivity                     TaskActivityEvent[]
  taskAssignees                    TaskAssignee[]
  teamMemberships                  TeamMember[]
  assignedTickets                  Ticket[]             @relation("AssignedTickets")
  openedTickets                    Ticket[]             @relation("OpenedTickets")
  messages                         TicketMessage[]
  timeEntries                      TimeEntry[]
  documents                        Document[]           @relation("DocumentAuthor")
  docFavorites                     DocFavorite[]
}

model Ticket {
  id                 String             @id @default(uuid())
  title              String
  description        String
  status             TicketStatus       @default(OPEN)
  priority           TicketPriority     @default(MEDIUM)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  resolvedAt         DateTime?
  closedAt           DateTime?
  openedById         String
  assigneeId         String?
  category           TicketCategory     @default(OTHER)
  timerPaused        Boolean            @default(false)
  timerPausedAt      DateTime?
  totalPausedSeconds Int                @default(0)
  inProgressAt       DateTime?
  timeSpentMinutes   Int?
  unit               TicketUnit?
  teamId             String?
  notifications      Notification[]
  assignee           User?              @relation("AssignedTickets", fields: [assigneeId], references: [id])
  openedBy           User               @relation("OpenedTickets", fields: [openedById], references: [id])
  team               Team?              @relation(fields: [teamId], references: [id])
  attachments        TicketAttachment[]
  messages           TicketMessage[]

  @@index([status])
  @@index([priority])
  @@index([openedById])
  @@index([assigneeId])
  @@index([teamId])
  @@index([category])
  @@index([unit])
}

model TicketMessage {
  id         String   @id @default(uuid())
  ticketId   String
  authorId   String
  content    String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  author     User     @relation(fields: [authorId], references: [id])
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId, createdAt])
}

model TicketAttachment {
  id        String   @id @default(uuid())
  ticketId  String
  filename  String
  url       String
  mimeType  String
  size      Int
  createdAt DateTime @default(now())
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  ticketId  String?
  type      NotificationType
  status    NotificationStatus @default(UNREAD)
  title     String
  message   String
  metadata  Json?
  createdAt DateTime           @default(now())
  readAt    DateTime?
  taskId    String?
  projectId String?
  project   Project?           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task      Task?              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  ticket    Ticket?            @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, createdAt])
  @@index([ticketId])
  @@index([taskId])
  @@index([projectId])
  @@index([status])
}

model Project {
  id            String         @id @default(uuid())
  name          String
  code          String?        @unique
  status        ProjectStatus  @default(ACTIVE)
  unit          TaskUnit?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdById   String?
  teamId        String?
  kanbanBoards  KanbanBoard[]  @relation("KanbanBoardProject")
  notifications Notification[]
  createdBy     User?          @relation("ProjectCreatedBy", fields: [createdById], references: [id])
  team          Team?          @relation(fields: [teamId], references: [id])
  tasks         Task[]

  @@index([status])
  @@index([unit])
  @@index([createdById])
  @@index([teamId])
}

model Task {
  id             String              @id @default(uuid())
  title          String
  description    String?
  acceptance     String?
  unit           TaskUnit
  status         TaskStatus          @default(TODO)
  priority       TaskPriority        @default(MEDIUM)
  estimatedHours Int                 @default(0)
  projectId      String?
  createdById    String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  completedAt    DateTime?
  teamId         String?
  kanbanCards    KanbanCard[]        @relation("KanbanCardTask")
  notifications  Notification[]
  createdBy      User?               @relation("TaskCreatedBy", fields: [createdById], references: [id])
  project        Project?            @relation(fields: [projectId], references: [id])
  team           Team?               @relation(fields: [teamId], references: [id])
  activity       TaskActivityEvent[]
  assignees      TaskAssignee[]
  timeEntries    TimeEntry[]

  @@index([projectId])
  @@index([teamId])
  @@index([status])
  @@index([priority])
  @@index([unit])
  @@index([updatedAt])
}

model TaskAssignee {
  taskId String
  userId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([taskId, userId])
  @@index([userId])
}

model TimeEntry {
  id        String        @id @default(uuid())
  taskId    String
  userId    String
  date      DateTime
  hours     Decimal       @db.Decimal(5, 2)
  type      TimeEntryType
  note      String?
  createdAt DateTime      @default(now())
  task      Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId, date])
  @@index([userId, date])
}

model TaskActivityEvent {
  id        String           @id @default(uuid())
  taskId    String
  type      TaskActivityType
  actorId   String
  message   String
  meta      Json?
  createdAt DateTime         @default(now())
  actor     User             @relation(fields: [actorId], references: [id], onDelete: Cascade)
  task      Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId, createdAt])
  @@index([actorId])
}

model KanbanBoard {
  id          String         @id @default(uuid())
  name        String
  description String?
  projectId   String?
  createdById String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  createdBy   User           @relation("KanbanBoardCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  project     Project?       @relation("KanbanBoardProject", fields: [projectId], references: [id])
  cards       KanbanCard[]
  columns     KanbanColumn[]
  members     KanbanMember[]

  @@index([projectId])
  @@index([createdById])
  @@index([updatedAt])
}

model KanbanColumn {
  id        String       @id @default(uuid())
  boardId   String
  status    KanbanStatus
  title     String
  order     Int
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  cards     KanbanCard[]
  board     KanbanBoard  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  @@unique([boardId, status])
  @@index([boardId, order])
}

model KanbanCard {
  id          String        @id @default(uuid())
  boardId     String
  columnId    String
  taskId      String?
  title       String
  description String?
  priority    TaskPriority?
  dueDate     DateTime?
  tags        String[]      @default([])
  assigneeId  String?
  order       Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  assignee    User?         @relation(fields: [assigneeId], references: [id])
  board       KanbanBoard   @relation(fields: [boardId], references: [id], onDelete: Cascade)
  column      KanbanColumn  @relation(fields: [columnId], references: [id], onDelete: Cascade)
  task        Task?         @relation("KanbanCardTask", fields: [taskId], references: [id])

  @@unique([boardId, taskId])
  @@index([boardId, columnId, order])
  @@index([taskId])
  @@index([assigneeId])
}

model KanbanMember {
  boardId   String
  userId    String
  role      KanbanMemberRole @default(EDITOR)
  createdAt DateTime         @default(now())
  board     KanbanBoard      @relation(fields: [boardId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([boardId, userId])
  @@index([userId])
}

model Document {
  id        String      @id @default(uuid())
  title     String
  slug      String      @unique
  summary   String
  content   String      @default("")
  category  DocCategory @default(GERAL)
  status    DocStatus   @default(DRAFT)
  tags      String[]    @default([])
  views     Int         @default(0)
  archived  Boolean     @default(false)
  authorId  String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  author      User          @relation("DocumentAuthor", fields: [authorId], references: [id])
  favoritedBy DocFavorite[]

  @@index([slug])
  @@index([authorId])
  @@index([category])
  @@index([status])
  @@index([archived])
  @@index([updatedAt])
  @@index([status, archived, updatedAt])
}

model DocFavorite {
  docId     String
  userId    String
  createdAt DateTime @default(now())

  document Document @relation(fields: [docId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([docId, userId])
  @@index([userId])
  @@index([docId])
}

model Team {
  id          String       @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  projects    Project[]
  tasks       Task[]
  members     TeamMember[]
  tickets     Ticket[]

  @@index([name])
}

model TeamMember {
  teamId    String
  userId    String
  createdAt DateTime @default(now())
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([teamId, userId])
  @@index([userId])
  @@index([teamId])
}

model CategoriaColaborador {
  id            String               @id @default(uuid())
  nome          String               @unique
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  colaboradores ColaboradorExterno[]

  @@index([nome])
}

model ColaboradorExterno {
  id              String                @id @default(uuid())
  nome            String
  email           String?
  senha           String?
  departamento    String?
  categoriaId     String?
  ativo           Boolean               @default(true)
  registradoPorId String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  usuario         String?
  categoria       CategoriaColaborador? @relation(fields: [categoriaId], references: [id])
  registradoPor   User?                 @relation("ColaboradorExternoRegistradoPor", fields: [registradoPorId], references: [id])

  @@index([ativo])
  @@index([registradoPorId])
  @@index([categoriaId])
}

model SslCertificate {
  id             String   @id @default(uuid())
  domain         String   @unique
  subdomains     String[] @default([])
  issuedAt       DateTime
  expiresAt      DateTime
  pendingRenewal Boolean  @default(false)
  lastExpiryAlertSentAt DateTime?
  lastExpiryAlertFor    DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([expiresAt])
  @@index([pendingRenewal])
  @@index([createdAt])
}

model UpdateCategory {
  id        String       @id @default(uuid())
  name      String       @unique
  slug      String       @unique
  color     String?
  order     Int          @default(0)
  isActive  Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  posts     UpdatePost[]

  @@index([order])
  @@index([isActive])
}

model UpdatePost {
  id      String           @id @default(uuid())
  title   String
  slug    String           @unique
  excerpt String
  content String
  status  UpdatePostStatus @default(DRAFT)

  // ✅ FK + RELATION (isso que está faltando no seu client)
  categoryId String
  category   UpdateCategory @relation(fields: [categoryId], references: [id], onDelete: Restrict)

  pinned Boolean @default(false)
  order  Int     @default(0)
  views  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attachments UpdatePostAttachment[]
  feedbacks   UpdatePostFeedback[]
}

model UpdatePostFeedback {
  id        String     @id @default(uuid())
  postId    String
  post      UpdatePost @relation(fields: [postId], references: [id], onDelete: Cascade)
  rating    Int // 1-5
  comment   String?    @db.Text
  createdAt DateTime   @default(now())

  @@index([postId])
}

model UpdatePostAttachment {
  id     String     @id @default(uuid())
  postId String
  post   UpdatePost @relation(fields: [postId], references: [id], onDelete: Cascade)

  filename String
  url      String
  mimeType String
  size     Int

  createdAt DateTime @default(now())
}

enum UserRole {
  USER
  AGENT
  ADMIN
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketCategory {
  HARDWARE
  SOFTWARE
  NETWORK
  EMAIL
  ACCESS
  OTHER
}

enum TicketUnit {
  ITJ
  SFS
  FOZ
  DIO
  AOL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskUnit {
  ITJ
  SFS
  FOZ
  DIO
  AOL
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

enum TimeEntryType {
  DEV
  TEST
  MEETING
  REWORK
}

enum TaskActivityType {
  TASK_CREATED
  TASK_UPDATED
  TASK_STATUS_CHANGED
  TASK_ASSIGNEES_CHANGED
  TIME_ENTRY_ADDED
  TIME_ENTRY_DELETED
}

enum KanbanStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum NotificationType {
  NEW_TICKET
  NEW_MESSAGE
  TICKET_ASSIGNED
  TICKET_STATUS_CHANGED
  TICKET_PRIORITY_CHANGED
  TASK_CREATED
  TASK_STATUS_CHANGED
  TASK_UPDATED
  TASK_ASSIGNED
  PROJECT_CREATED
  PROJECT_TASK_ADDED
  PROJECT_UPDATED
}

enum NotificationStatus {
  UNREAD
  READ
}

enum DocCategory {
  INFRA
  SISTEMAS
  PROCESSOS
  SEGURANCA
  GERAL
}

enum DocStatus {
  DRAFT
  PUBLISHED
}

enum UpdatePostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum KanbanMemberRole {
  VIEWER
  EDITOR
  ADMIN
}
